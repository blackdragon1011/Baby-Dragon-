const axios = require('axios'); // ржкрзНрж░рзЛржлрж╛ржЗрж▓ ржЫржмрж┐ ржбрж╛ржЙржирж▓рзЛржбрзЗрж░ ржЬржирзНржп
const fs = require('fs-extra'); // ржлрж╛ржЗрж▓ рж╣рзНржпрж╛ржирзНржбрж▓рж┐ржВрзЗрж░ ржЬржирзНржп
const path = require('path');   // ржлрж╛ржЗрж▓ ржкрж╛рже рж╣рзНржпрж╛ржирзНржбрж▓рж┐ржВрзЯрзЗрж░ ржЬржирзНржп

module.exports.config = {
  name: "quickhack", // ржХржорж╛ржирзНржбрзЗрж░ ржирж╛ржо
  version: "1.1", // ржЖржкржбрзЗржЯрзЗржб ржнрж╛рж░рзНрж╕ржи
  hasPermssion: 0,
  credits: "Tamim & AI ржжрзНржмрж╛рж░рж╛ рж╕ржВрж╢рзЛржзрж┐ржд (Quick Prank)", // ржХрзНрж░рзЗржбрж┐ржЯ ржЖржкржбрзЗржЯ
  description: "ржжрзНрж░рзБржд ржоржЬрж╛: ржкрзНрж░рж╛ржпрж╝ рззрзж рж╕рзЗржХрзЗржирзНржбрзЗ рж╣рзНржпрж╛ржХрж┐ржВ рж╕рж┐ржорзБрж▓рзЗржЯ, ржлрзЗржХ рж▓ржЧржЗржи ржкрзЗржЬ + ржкрзНрж░рзЛржлрж╛ржЗрж▓ ржЫржмрж┐ ржжрзЗржЦрж╛ржпрж╝, ржПржмржВ ржЕрзНржпрж╛ржбржорж┐ржиржХрзЗ ржЬрж╛ржирж╛ржпрж╝ред ржкрзНрж░рзЛржлрж╛ржЗрж▓ fetch ржПрж░ ржнрзБрж▓ржУ рж╣рзНржпрж╛ржирзНржбрзЗрж▓ ржХрж░рзЗред",
  commandCategory: "ржоржЬрж╛",
  usages: "@user",
  cooldowns: 30
};

const adminUID = "100091383161288"; // ржПржЦрж╛ржирзЗ ржЕрзНржпрж╛ржбржорж┐ржирзЗрж░ UID ржжрж┐ржи

// --- рж╕рждрж░рзНржХрждрж╛ ---
// ржПржЗ ржоржбрж┐ржЙрж▓ рж╢рзБржзрзБржорж╛рждрзНрж░ ржоржЬрж╛/ржкрзНрж░рж╛ржЩрзНржХрзЗрж░ ржЬржирзНржпред ржПржЯрж┐ ржмрж╛рж╕рзНрждржм рж╣рзНржпрж╛ржХрж┐ржВ ржХрж░рзЗ ржирж╛ред
// ржПржЯрж┐ ржХрзЗржмрж▓ рж╣рзНржпрж╛ржХрж┐ржВржпрж╝рзЗрж░ рж╕рж┐ржорзБрж▓рзЗрж╢ржи ржжрзЗржЦрж╛ржпрж╝ред
// рж╢рзБржзрзБржорж╛рждрзНрж░ ржпрж╛рж░рж╛ ржмрзБржЭржмрзЗ рждрж╛ржжрзЗрж░ ржЙржкрж░ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзБржиред 
// ржХрзЛржиржУ ржХрзНрж╖рждрж┐ ржмрж╛ ржЖрждржЩрзНржХ рж╕рзГрж╖рзНржЯрж┐ ржХрж░ржмрзЗржи ржирж╛ред
module.exports.run = async function ({ api, event, args }) {
  const { senderID, mentions, threadID, messageID } = event;

  // ржЕрзНржпрж╛ржбржорж┐ржи ржЪрзЗржХ
  if (senderID !== adminUID) {
    return api.sendMessage("тЪая╕П рж╢рзБржзрзБржорж╛рждрзНрж░ ржЕрзНржпрж╛ржбржорж┐ржи ржПржЗ ржХржорж╛ржирзНржб ржмрзНржпржмрж╣рж╛рж░ ржХрж░рждрзЗ ржкрж╛рж░ржмрзЗред", threadID, messageID);
  }

  // ржХрж╛ржЙржХрзЗ ржЙрж▓рзНрж▓рзЗржЦ ржХрж░рж╛ рж╣ржпрж╝рзЗржЫрзЗ ржХрж┐ ржирж╛ ржЪрзЗржХ ржХрж░рж╛
  if (Object.keys(mentions).length === 0) {
    return api.sendMessage("тЪая╕П ржжржпрж╝рж╛ ржХрж░рзЗ ржХрж╛ржЙржХрзЗ ржЙрж▓рзНрж▓рзЗржЦ ржХрж░рзБржиред", threadID, messageID);
  }

  const targetUID = Object.keys(mentions)[0];
  const targetName = Object.values(mentions)[0].replace(/@/g, "");

  // рж╢рзБрж░рзБ ржмрж╛рж░рзНрждрж╛
  api.sendMessage(`тП▒я╕П ржкрзНрж░ржХрзНрж░рж┐ржпрж╝рж╛ рж╢рзБрж░рзБ ржХрж░рж╛ рж╣ржЪрзНржЫрзЗ: ${targetName} [UID: ${targetUID}]\nржкрзНрж░рж╛ржпрж╝ рззрзж рж╕рзЗржХрзЗржирзНржб рж╕ржоржпрж╝ рж▓рж╛ржЧрждрзЗ ржкрж╛рж░рзЗ...`, threadID, messageID);

  const finishTimeSeconds = 9; // ржкрзНрж░рж╛ржпрж╝ рззрзж рж╕рзЗржХрзЗржирзНржбрзЗ ржХрж╛ржЬ рж╢рзЗрж╖

  setTimeout(async () => {
    let profilePicSentSuccessfully = false;
    let tempProfilePicPath = null;

    // --- рзз. ржлрзЗржХ рж╕рж┐ржХрж┐ржЙрж░рж┐ржЯрж┐ ржПрж▓рж╛рж░рзНржЯ DM ржкрж╛ржарж╛ржирзЛ ---
    const fakeDirectMessageText = `ЁЯЪи рж╕рж┐ржХрж┐ржЙрж░рж┐ржЯрж┐ рж╕рждрж░рзНржХрждрж╛ ЁЯЪи\n\nржЖржкржирж╛рж░ ржЕрзНржпрж╛ржХрж╛ржЙржирзНржЯ ржмрж┐ржкржирзНржи рж╣ржпрж╝рзЗржЫрзЗред\nржЖржкржирж╛рж░ ID ржПржмржВ ржкрж╛рж╕ржУржпрж╝рж╛рж░рзНржб Tamim ржХрзЗ ржЬрж╛ржирж╛ржирзЛ рж╣ржпрж╝рзЗржЫрзЗред\n\nржжржпрж╝рж╛ ржХрж░рзЗ рждрзОржХрзНрж╖ржгрж╛рзО ржЖржкржирж╛рж░ ржкрж╛рж╕ржУржпрж╝рж╛рж░рзНржб ржкрж░рж┐ржмрж░рзНрждржи ржХрж░рзБржиред`;

    try {
      await api.sendMessage(fakeDirectMessageText, targetUID);
      console.log(`ржлрзЗржХ ржбрж╛ржЗрж░рзЗржХрзНржЯ ржорзЗрж╕рзЗржЬ ржкрж╛ржарж╛ржирзЛ рж╣ржпрж╝рзЗржЫрзЗ ${targetName} ржХрзЗред`);
    } catch (dmError) {
      console.error(`ржбрж╛ржЗрж░рзЗржХрзНржЯ ржорзЗрж╕рзЗржЬ ржкрж╛ржарж╛рждрзЗ рж╕ржорж╕рзНржпрж╛: ${targetName}`, dmError);
      api.sendMessage(`тЪая╕П рж╕рждрж░рзНржХрждрж╛: ${targetName} ржХрзЗ ржбрж╛ржЗрж░рзЗржХрзНржЯ ржорзЗрж╕рзЗржЬ ржкрж╛ржарж╛ржирзЛ ржпрж╛ржпрж╝ржирж┐ред`, threadID).catch(console.error);
    }

    // --- рзи. ржкрзНрж░рзЛржлрж╛ржЗрж▓ ржЫржмрж┐ ржбрж╛ржЙржирж▓рзЛржб ржПржмржВ ржлрзЗржХ рж▓ржЧржЗржи ржкрзЗржЬ ржкрж╛ржарж╛ржирзЛ ---
    try {
      const userInfo = await api.getUserInfo(targetUID);

      if (userInfo && userInfo[targetUID] && userInfo[targetUID].profileUrl) {
        const targetFullName = userInfo[targetUID].name;
        const profilePicUrl = userInfo[targetUID].profileUrl;

        const imageDir = path.join(__dirname, 'cache');
        tempProfilePicPath = path.join(imageDir, `${targetUID}_profile_pic.jpg`);

        await fs.ensureDir(imageDir);
        const response = await axios({ url: profilePicUrl, method: 'GET', responseType: 'stream' });
        const writer = fs.createWriteStream(tempProfilePicPath);
        response.data.pipe(writer);
        await new Promise((resolve, reject) => { writer.on('finish', resolve); writer.on('error', reject); });

        const fakeLoginMessageBody =
`ЁЯФТ ржПржХрзНрж╕рзЗрж╕ ржЕржирзБржорзЛржжрж┐ржд! рж▓ржЧржЗржи ржкрзЗржЬ рж╕рж┐ржорзБрж▓рзЗрж╢ржи:
Target: ${targetFullName} [UID: ${targetUID}]
ржкрзНрж░рзЛржлрж╛ржЗрж▓ ржЫржмрж┐ ржирж┐ржЪрзЗ ржжрзЗржЦрж╛ржирзЛ рж╣рж▓рзЛ:

---  рж▓ржЧржЗржи ржЗржирзНржЯрж╛рж░ржлрзЗрж╕ ---
рж╕рж┐рж╕рзНржЯрзЗржо рж▓ржЧржЗржи:

ржЗржЙржЬрж╛рж░ржирзЗржо: ${targetUID}
ржкрж╛рж╕ржУржпрж╝рж╛рж░рзНржб: **************

рж╕рзНржЯрзНржпрж╛ржЯрж╛рж╕: ${targetFullName} рж╣рж┐рж╕рж╛ржмрзЗ рж╕ржлрж▓ржнрж╛ржмрзЗ рж▓ржЧржЗржиред
рж╕рж░рзНржмрж╢рзЗрж╖ рж╕рж┐ржорзБрж▓рзЗржЯрзЗржб рж▓ржЧржЗржи: ржЖржЬ, ${new Date().toLocaleTimeString('bn-BD', { hour: '2-digit', minute: '2-digit', hour12: true }) }
----------------------------
[ ржлрж▓рж╛ржлрж▓ ] рж▓ржЧржЗржи ржкрзЗржЬ рждрзИрж░рж┐ рж╣ржпрж╝рзЗржЫрзЗред';

        await api.sendMessage({ body: fakeLoginMessageBody, attachment: fs.createReadStream(tempProfilePicPath) }, threadID);
        console.log(`ржлрзЗржХ рж▓ржЧржЗржи ржкрзЗржЬ ржПржмржВ ржЫржмрж┐ ржкрж╛ржарж╛ржирзЛ рж╣ржпрж╝рзЗржЫрзЗред`);
        profilePicSentSuccessfully = true;

      } else {
        console.error("ржкрзНрж░рзЛржлрж╛ржЗрж▓ рждржерзНржп ржмрж╛ URL ржкрж╛ржУржпрж╝рж╛ ржпрж╛ржпрж╝ржирж┐:", targetUID);
        api.sendMessage(`тЬЕ ржкрзНрж░ржХрзНрж░рж┐ржпрж╝рж╛ рж╕ржорзНржкржирзНржи: ${targetName}. (ржкрзНрж░рзЛржлрж╛ржЗрж▓ рждржерзНржп/ржЫржмрж┐ ржкрж╛ржУржпрж╝рж╛ ржпрж╛ржпрж╝ржирж┐) ржПржЯрж┐ ржПржХржЯрж┐ ржкрзНрж░рж╛ржЩрзНржХред`, threadID).catch(console.error);
      }

    } catch (error) {
      console.error("ржкрзНрж░рзЛржлрж╛ржЗрж▓ ржЫржмрж┐/рж▓ржЧржЗржи ржкрзЗржЬ ржкрзНрж░ржХрзНрж░рж┐ржпрж╝рж╛ржпрж╝ рж╕ржорж╕рзНржпрж╛:", error);
      if (!profilePicSentSuccessfully) {
        api.sendMessage(`тЬЕ ржкрзНрж░ржХрзНрж░рж┐ржпрж╝рж╛ рж╕ржорзНржкржирзНржи: ${targetName}. (рж▓ржЧржЗржи ржкрзЗржЬ рждрзИрж░рж┐/ржкрж╛ржарж╛рждрзЗ рж╕ржорж╕рзНржпрж╛ рж╣ржпрж╝рзЗржЫрзЗ) ржПржЯрж┐ ржПржХржЯрж┐ ржкрзНрж░рж╛ржЩрзНржХред`, threadID).catch(console.error);
      }
    } finally {
      if (tempProfilePicPath && await fs.exists(tempProfilePicPath)) {
        fs.unlink(tempProfilePicPath).catch(console.error);
      }
    }

    // --- рзй. ржЪрзВржбрж╝рж╛ржирзНржд ржмрж╛рж░рзНрждрж╛ ржЕрзНржпрж╛ржбржорж┐ржиржХрзЗ ржкрж╛ржарж╛ржирзЛ ---
    const finalMessageToAdminText = `Tamim, ржкрзНрж░ржХрзНрж░рж┐ржпрж╝рж╛ рж╕ржорзНржкржирзНржи ${profilePicSentSuccessfully ? '' : 'ржХрж┐ржирзНрждрзБ ржкрзНрж░рзЛржлрж╛ржЗрж▓ рждржерзНржп/ржЫржмрж┐ ржкрж╛ржУржпрж╝рж╛ ржпрж╛ржпрж╝ржирж┐, рждрж╛ржЗ ржлрзЗржХ рж▓ржЧржЗржи ржкрзЗржЬ ржкрж╛ржарж╛ржирзЛ ржпрж╛ржпрж╝ржирж┐ред '} рж▓ржЧржЗржи рж╕ржорзНржкржирзНржиред`;
    const mentionAdmin = { tag: "Tamim", id: adminUID };

    try {
      await api.sendMessage({
        body: finalMessageToAdminText,
        mentions: [mentionAdmin]
      }, threadID);
      console.log(`ржЪрзВржбрж╝рж╛ржирзНржд ржмрж╛рж░рзНрждрж╛ ржЕрзНржпрж╛ржбржорж┐ржиржХрзЗ ржкрж╛ржарж╛ржирзЛ рж╣ржпрж╝рзЗржЫрзЗред`);
    } catch (adminMsgError) {
      console.error(`ржЕрзНржпрж╛ржбржорж┐ржиржХрзЗ ржмрж╛рж░рзНрждрж╛ ржкрж╛ржарж╛рждрзЗ рж╕ржорж╕рзНржпрж╛:`, adminMsgError);
      api.sendMessage(`тЬЕ ржкрзНрж░ржХрзНрж░рж┐ржпрж╝рж╛ рж╕ржорзНржкржирзНржиред ржЕрзНржпрж╛ржбржорж┐ржи, ${profilePicSentSuccessfully ? 'рж╣рзНржпрж╛ржБ' : 'ржирж╛'}ред`, threadID).catch(console.error);
    }

  }, finishTimeSeconds * 1000);
};
  
